name: iOS-ipa-build

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: üéâ iOS Build
    runs-on: macos-latest
    permissions:
      contents: write # –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è git push

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∫–æ–º–º–∏—Ç–∏—Ç—å –æ—Ç –∏–º–µ–Ω–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
          # –∞ –Ω–µ GITHUB_TOKEN, –≤–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è Personal Access Token (PAT)
          # —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ —É–∫–∞–∑–∞—Ç—å –µ–≥–æ –∑–¥–µ—Å—å:
          # token: ${{ secrets.YOUR_PAT_WITH_REPO_WRITE_ACCESS }}
          # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è GITHUB_TOKEN, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞
          # –Ω–∞ —Ç–µ–∫—É—â–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, –µ—Å–ª–∏ permissions —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.
          fetch-depth: 0 # –ù—É–∂–Ω–æ –¥–ª—è git push, —á—Ç–æ–±—ã –∏–º–µ—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Update CocoaPods repositories
        run: pod repo update
        working-directory: ios

      - name: Build iOS (release, no codesign)
        run: flutter build ios --release --no-codesign

      - name: Create Payload directory
        run: mkdir Payload
        working-directory: build/ios/iphoneos

      - name: Move Runner.app to Payload
        run: mv Runner.app/ Payload
        working-directory: build/ios/iphoneos

      - name: Zip output to IPA
        run: zip -qq -r -9 FlutterIpaExport.ipa Payload
        working-directory: build/ios/iphoneos

      - name: Create builds directory in repository
        run: mkdir -p builds # -p —Å–æ–∑–¥–∞–µ—Ç, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏ –Ω–µ –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å

      - name: Move IPA to builds directory
        run: mv build/ios/iphoneos/FlutterIpaExport.ipa builds/FlutterIpaExport.ipa

      - name: Commit and Push IPA file
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add builds/FlutterIpaExport.ipa
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ–º–º–∏—Ç–∞
          if git diff --staged --quiet; then
            echo "No changes to commit in builds/FlutterIpaExport.ipa."
          else
            git commit -m "CI: Add/Update iOS build artifact (FlutterIpaExport.ipa)"
            # –£–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ç–∫—É, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –ø—É—à–∏—Ç—å (–æ–±—ã—á–Ω–æ —Ç–∞ –∂–µ, —á—Ç–æ –∏ –≤—ã–∑–≤–∞–ª–∞ workflow)
            # GITHUB_REF_NAME —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–º—è –≤–µ—Ç–∫–∏ –∏–ª–∏ —Ç–µ–≥–∞
            git push origin HEAD:${{ github.ref_name }}
          fi
